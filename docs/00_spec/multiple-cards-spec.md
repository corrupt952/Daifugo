# Phase 1.5: 複数枚出し機能 - 機能仕様書

## メタデータ

- **作成日**: 2025-11-02
- **ステータス**: Draft
- **対象**: Phase 1.5 (複数枚出し・階段・革命)
- **前提**: Phase 1（基本機能 + ローカルルール）完了

---

## 目的

大富豪の戦略性を高める複数枚出し機能を実装する。

Phase 1の1枚出しに加えて、ペア・3枚・4枚・階段出しを実装し、革命ルールにも対応することで、より戦略的で奥深いゲームプレイを実現する。

---

## スコープ

### Phase 1.5で実装するもの

#### 基本の複数枚出し
- **ペア出し**（同じランク2枚）
- **3枚出し**（同じランク3枚）
- **4枚出し**（同じランク4枚）→ 革命発動
- **階段出し**（連続する3枚以上、同じスート）

#### 革命システム
- 4枚出しで強さ逆転（3が最強、2が最弱）
- ゲーム終了まで継続（場が流れても継続）
- 革命中は「革命」マーク表示

#### 既存ローカルルールの複数枚対応
- **8切り**: 8を含む複数枚でも場をリセット
- **縛り**: 同じスートの複数枚2連続で縛り発動
- **11バック**: Jを含む複数枚でも一時革命発動
- **スペ3返し**: スペ3単体のみ（複数枚は対応しない）
- **禁止上がり**: 禁止カード（2、8、ジョーカー、スペ3）を含む複数枚で上がると負け

#### UI拡張
- 複数枚選択（クリックで選択/解除）
- 選択中カードの視覚的フィードバック
- 無効な組み合わせの警告表示
- プレイ可能カードのハイライト（Phase 1と同じ方式）

#### AI拡張
- ペア・3枚・4枚の判断
- 階段の判断
- 革命を起こすタイミングの判断（シンプルな戦略）

### Phase 1.5で実装しないもの

#### 高度な出し方
- ❌ 5枚以上の出し方（実用性が低い）
- ❌ スート縛り階段（複雑すぎる）
- ❌ ジョーカーを含む階段（Phase 2以降）

#### 高度なUI機能
- ❌ インテリジェントハイライト（有効な次の手の提案）
- ❌ 自動組み合わせ提案

#### その他
- ❌ 階級制度（Phase 2で実装）
- ❌ カード交換（Phase 2で実装）

---

## 用語定義

- **ペア**: 同じランクのカード2枚
- **3枚**: 同じランクのカード3枚
- **4枚**: 同じランクのカード4枚（革命発動）
- **階段**: 連続するランクのカード3枚以上、同じスート（例: ♠3-4-5）
- **革命**: 4枚出しで発動、カードの強さが逆転（3が最強、2が最弱）
- **一時革命**: 11バックによる一時的な強さ逆転（場が流れるまで）
- **プレイパターン**: 出し方の種類（単体/ペア/3枚/4枚/階段）

---

## ユーザーシナリオ

### シナリオ1: ペア出し（場が空）

**前提条件**:
- 人間プレイヤーのターン
- 場が空
- 手札に♠5、♥5を持っている

**手順**:
1. プレイヤーが♠5をクリック → 選択状態
2. プレイヤーが♥5をクリック → 選択状態（2枚選択中）
3. 「Play Card」ボタンをクリック
4. システムが組み合わせを検証（同じランク2枚 → ペア）
5. ペアが場に出される
6. 手札から2枚が消える
7. ターンが次のプレイヤーへ移る

**期待される結果**:
- ペアが正常にプレイされる
- 場に「♥5 ♠5」が表示される
- 次のプレイヤーはペアのみプレイ可能

---

### シナリオ2: ペアに対してペアを出す

**前提条件**:
- 人間プレイヤーのターン
- 場に♠5、♥5のペアがある
- 手札に♦7、♣7を持っている

**手順**:
1. プレイヤーが♦7、♣7を選択
2. 「Play Card」ボタンをクリック
3. システムが検証（場はペア → 同じランクのペアのみ可、7 > 5 → OK）
4. ペアが場に出される
5. 場が「♦7 ♣7」に更新される

**期待される結果**:
- より強いペアがプレイされる
- 場が更新される

---

### シナリオ3: 階段出し

**前提条件**:
- 人間プレイヤーのターン
- 場が空
- 手札に♠3、♠4、♠5を持っている

**手順**:
1. プレイヤーが♠3、♠4、♠5を選択
2. 「Play Card」ボタンをクリック
3. システムが検証（連続ランク + 同じスート → 階段3枚）
4. 階段が場に出される
5. 次のプレイヤーは階段3枚のみプレイ可能

**期待される結果**:
- 階段が正常にプレイされる
- 場に「♠3-4-5」が表示される

---

### シナリオ4: 4枚出しで革命発動

**前提条件**:
- CPUプレイヤーのターン
- 場に♠3がある（単体）
- CPUが♦5、♣5、♥5、♠5を持っている

**手順**:
1. CPUが4枚を選択してプレイ
2. システムが検証（同じランク4枚 → 4枚出し）
3. 革命が発動
4. カードの強さが逆転（3が最強、2が最弱、ジョーカーは最強のまま）
5. 画面に「革命」表示
6. 場に「5555」が表示される
7. 次のプレイヤーは4枚のみプレイ可能

**期待される結果**:
- 革命が発動する
- 強さが逆転する
- 革命マークが表示される
- ゲーム終了まで革命状態が継続

---

### シナリオ5: 無効な組み合わせを選択

**前提条件**:
- 人間プレイヤーのターン
- 場が空
- 手札に♠5、♠6、♠7を持っている

**手順**:
1. プレイヤーが♠5、♠7を選択（連続していない）
2. 「Play Card」ボタンをクリック
3. システムが検証（同じランクでも階段でもない → 無効）
4. エラー警告を表示「無効な組み合わせです。同じランクまたは階段を選んでください」
5. カードはプレイされない
6. 選択状態は維持される

**期待される結果**:
- 無効な組み合わせは受け付けない
- 分かりやすいエラーメッセージを表示
- プレイヤーは選択を修正できる

---

### シナリオ6: 場のパターンと異なる枚数を出す

**前提条件**:
- 人間プレイヤーのターン
- 場に♠5、♥5のペアがある
- 手札に♦7、♣7、♥7を持っている

**手順**:
1. プレイヤーが♦7、♣7、♥7を選択（3枚）
2. 「Play Card」ボタンをクリック
3. システムが検証（場はペア → ペアのみ可、3枚は無効）
4. エラー警告を表示「場と同じ枚数を出してください（2枚）」
5. カードはプレイされない

**期待される結果**:
- 場と異なる枚数は受け付けない
- 明確なエラーメッセージを表示

---

### シナリオ7: 革命中のプレイ

**前提条件**:
- 革命発動中（3が最強、2が最弱）
- 人間プレイヤーのターン
- 場に♠10がある（単体）
- 手札に♠5を持っている

**手順**:
1. プレイヤーが♠5を選択
2. 「Play Card」ボタンをクリック
3. システムが検証（革命中 → 5 < 10 → OK）
4. カードがプレイされる

**期待される結果**:
- 革命中は弱いカードが強いカードに勝つ
- 正常にプレイされる

---

### シナリオ8: 8のペアで場をリセット

**前提条件**:
- 人間プレイヤーのターン
- 場に♠10、♥10のペアがある
- 手札に♦8、♣8を持っている

**手順**:
1. プレイヤーが♦8、♣8を選択
2. 「Play Card」ボタンをクリック
3. システムが検証（8を含むペア → 8切り発動）
4. ペアがプレイされる
5. 場が即座にリセットされる
6. 同じプレイヤーが続行（任意のカードをプレイ可能）

**期待される結果**:
- 8のペアで場がリセットされる
- 同じプレイヤーが続行

---

### シナリオ9: 禁止カードを含むペアで上がる

**前提条件**:
- 禁止上がりルール有効
- 人間プレイヤーのターン
- 場に♠5、♥5のペアがある
- 手札に♦2、♣2のみ（最後の2枚）

**手順**:
1. プレイヤーが♦2、♣2を選択
2. 「Play Card」ボタンをクリック
3. システムが検証（2のペア → OK）
4. ペアがプレイされる
5. 手札が0枚になる
6. 禁止カード（2）を含むペアで上がった → 敗北
7. ゲーム終了画面「You Lose! (禁止上がり)」

**期待される結果**:
- 禁止カードを含むペアで上がると敗北
- 禁止上がりが正しく判定される

---

## 機能要件

### FR-101: 複数枚選択UI

**要件**:
システムはプレイヤーが複数枚のカードを選択できる。

**詳細**:
- カードをクリックで選択/解除（Phase 1と同じ）
- 選択中のカードは視覚的にフィードバック（translateY上昇）
- 選択枚数に制限なし（バリデーションはプレイ時）
- 選択中カードは`card--selected`クラスを付与

---

### FR-102: プレイパターン判定

**要件**:
システムは選択されたカードの組み合わせからプレイパターンを判定する。

**詳細**:
- **単体**: 1枚
- **ペア**: 同じランク2枚
- **3枚**: 同じランク3枚
- **4枚**: 同じランク4枚
- **階段**: 連続するランク3枚以上、同じスート
- **無効**: 上記以外

**判定優先順位**:
1. 同じランク判定（ペア/3枚/4枚）
2. 階段判定（連続ランク + 同じスート）
3. どちらでもない → 無効

---

### FR-103: 場のパターンマッチング

**要件**:
システムは場のプレイパターンと同じパターン、同じ枚数のみ受け付ける。

**詳細**:
- 場が空 → 全パターン可
- 場が単体 → 単体のみ可
- 場がペア → ペアのみ可（より強いランク）
- 場が3枚 → 3枚のみ可（より強いランク）
- 場が4枚 → 4枚のみ可（より強いランク）
- 場が階段N枚 → 階段N枚のみ可（より強いランク）

---

### FR-104: 革命システム

**要件**:
4枚出しで革命が発動し、カードの強さが逆転する。

**詳細**:
- 4枚出しでゲーム状態に「革命」フラグを立てる
- 革命中はカード強さを逆転（3=3, 4=4, ..., K=13, A=14, 2=15 → 3=15, 4=14, ..., A=3, 2=2）
- ジョーカーは革命中も最強（16のまま）
- 革命はゲーム終了まで継続（場が流れても継続）
- 画面に「革命」マークを表示

**革命と一時革命（11バック）の関係**:
- 革命中に11バック発動 → 一時的に通常に戻る（場が流れるまで）
- 通常時に11バック発動 → 一時的に革命状態（場が流れるまで）
- つまり、11バックは現在の状態を反転させる

---

### FR-105: 階段の定義

**要件**:
システムは連続するランクのカード3枚以上、同じスートを階段として認識する。

**詳細**:
- 最小3枚、最大13枚（A-2-3-...-K-A）
- 同じスート必須
- ランクは連続必須（3-4-5 OK、3-5-7 NG）
- ジョーカーは階段に含めない（Phase 1.5では未対応）
- A-2-3やK-A-2のような回り階段は未対応（Phase 2以降）

**階段の強さ比較**:
- 最も強いカードで比較
- 例: ♠3-4-5 vs ♠6-7-8 → 8 > 5 → ♠6-7-8の勝ち
- 革命中は最も弱いカードで比較

---

### FR-106: 8切りの複数枚対応

**要件**:
8を含む複数枚でも場をリセットする。

**詳細**:
- 8のペア、8の3枚、8の4枚で場をリセット
- 8を含む階段（例: ♠7-8-9）も場をリセット
- リセット後、同じプレイヤーが続行
- 4枚の場合、革命も同時発動

---

### FR-107: 縛りの複数枚対応

**要件**:
同じスートの複数枚が2連続でプレイされた時、縛りが発動する。

**詳細**:
- ペア・3枚・4枚：最後の2プレイが同じスートの同じパターン → 縛り発動
  - 例: ♠5♠5 → ♠7♠7 → 縛り（スペード）
  - 例: ♠5♥5 → ♠7♠7 → 縛らない（1プレイ目が混合スート）
- 階段：既に同じスート必須なので、階段2連続で自動縛り
- ジョーカーを含むプレイは縛りに影響しない
- 縛り中は同じスートのみプレイ可能

**判定ロジック**:
1. 最後のプレイのカードが全て同じスートか確認
2. その前のプレイのカードが全て同じスートか確認
3. 両方とも同じスートで、かつ同じスート → 縛り発動

---

### FR-108: 11バックの複数枚対応

**要件**:
Jを含む複数枚でも一時革命が発動する。

**詳細**:
- Jのペア、Jの3枚、Jの4枚で一時革命発動
- Jを含む階段（例: ♠10-J-Q）でも一時革命発動
- 場が流れるまで継続
- 4枚の場合、革命も同時発動（永続革命 + 一時革命反転）

---

### FR-109: スペ3返しは単体のみ

**要件**:
スペ3返しは単体プレイのみ対応、複数枚は未対応。

**詳細**:
- Phase 1と同じ（スペ3単体 vs ジョーカー単体）
- スペ3のペア vs ジョーカーのペア → 通常のルールで判定（スペ3返し無効）
- Phase 2以降で複数枚対応を検討

---

### FR-110: 禁止上がりの複数枚対応

**要件**:
禁止カード（2、8、ジョーカー、スペ3）を含む複数枚で上がると負ける。

**詳細**:
- 最後にプレイしたカードに禁止カードが1枚でも含まれていたら負け
- 例: ♦2、♣2で上がる → 負け
- 例: ♦8、♣8、♥8で上がる → 負け
- 例: ♠3、♥5のペア（♠3を含む） → 負け（階段の場合）

---

### FR-111: エラーハンドリング

**要件**:
無効な組み合わせや操作に対して、分かりやすいエラーメッセージを表示する。

**詳細**:
- 無効な組み合わせ → 「無効な組み合わせです。同じランクまたは階段を選んでください」
- 場と異なる枚数 → 「場と同じ枚数を出してください（X枚）」
- 場と異なるパターン → 「場と同じパターンを出してください（ペア/3枚/4枚/階段）」
- 弱いカード → 「より強いカードを出してください」
- 縛り違反 → 「縛り中です。♠のカードのみ出せます」

---

### FR-112: AIの複数枚判断

**要件**:
AIは複数枚出しを適切に判断してプレイする。

**詳細**:

**Phase 1.5のシンプルな戦略**:
1. 場のパターンに合うカードを抽出
2. プレイ可能な最弱の組み合わせを選択
3. 革命は起こさない（4枚持っていても3枚で出す）

**具体例**:
- 場が空 → 単体で最弱カードを出す（ペア温存）
- 場がペア → 手持ちのペアから最弱を出す
- 場が階段3枚 → 手持ちの階段3枚から最弱を出す

**Phase 2以降で高度化**:
- 革命を起こすタイミングの判断
- ペアを温存する/すぐ出すの判断
- 階段を作る/個別に出すの判断

---

## 非機能要件

### NFR-101: パフォーマンス

**要件**:
複数枚選択・バリデーションは即座にレスポンスする。

**詳細**:
- カード選択のレスポンス: 50ms以内
- プレイパターン判定: 100ms以内
- 階段判定: 100ms以内

---

### NFR-102: テスタビリティ

**要件**:
全てのロジックは純粋C#クラスで実装し、ユニットテスト可能にする。

**詳細**:
- PlayPatternDetector（純粋クラス）
- PlayableCardsCalculator（拡張）
- GameLogic（拡張）
- AIPlayerStrategy（拡張）

---

## 成功基準

### SC-101: 複数枚出しが正常動作

**基準**:
ペア、3枚、4枚、階段が正しくプレイできる。

**測定方法**:
- 各パターンを手動テストで確認
- ユニットテストで全パターン網羅

---

### SC-102: 革命が正常動作

**基準**:
4枚出しで革命が発動し、強さが逆転する。

**測定方法**:
- 革命発動を確認
- 革命中のカードプレイを確認
- ゲーム終了まで革命が継続することを確認

---

### SC-103: 特殊ルールが複数枚対応

**基準**:
8切り、縛り、11バック、禁止上がりが複数枚で正常動作する。

**測定方法**:
- 各特殊ルールを複数枚でテスト
- ユニットテストで全パターン網羅

---

### SC-104: AIが複数枚をプレイできる

**基準**:
AIがペア、3枚、4枚、階段を適切にプレイする。

**測定方法**:
- AI vs AI を10ゲーム完走
- AIが複数枚を正しくプレイすることを確認

---

### SC-105: エラーハンドリングが適切

**基準**:
無効な操作に対して分かりやすいエラーメッセージを表示する。

**測定方法**:
- 無効な組み合わせを選択してエラー表示を確認
- エラーメッセージが分かりやすいことを確認

---

## 制約条件

### 技術制約
- Unity 6.0.2.7f2
- UI Toolkit（Phase 1と同じ）
- 既存のアーキテクチャを拡張（破壊的変更なし）

### ゲームデザイン制約
- Phase 1の1枚出しも引き続き使用可能
- ジョーカーを含む階段は未対応（Phase 2以降）
- 5枚以上の出し方は未対応

---

## 次のステップ

この仕様書を基に、以下を実行する：

1. **/clarify**: 曖昧な部分を明確化（特にAI戦略、縛りの詳細判定）
2. **/plan**: 技術実装計画の策定（データ構造、クラス設計）
3. **/tasks**: 実装タスクへの分解
4. **/implement**: 実装の実行
