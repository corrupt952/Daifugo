# Phase 1: 大富豪 2D版 - 機能仕様書

## メタデータ

- **作成日**: 2025-10-29
- **ステータス**: Draft
- **対象**: Phase 1 (2D UI Toolkit版)

---

## 目的

大富豪の基本ルールに従い、**まともにプレイできる**大富豪ゲームを実装する。

Phase 1では、ゲームとして成立する最小限の機能を実装し、実際に遊べる状態にすることを目指す。

---

## スコープ

### Phase 1で実装するもの

#### 基本ゲームルール
- プレイ人数：4人固定
- カード：54枚（**52枚 + ジョーカー2枚**）
- カードの強さ：**ジョーカー** > 2 > A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3
- 1枚出しのみ（複数枚出し、階段出しなし）
- パス機能
- 場の流れ（全員パスで流れる）
- 勝敗判定（手札が0枚で勝利、ただし禁止上がりで負け）

#### 実装済みローカルルール
- ✅ **8切り**（8で場を流す、同じプレイヤー続行）
- ✅ **縛り**（同じスート2枚連続で縛り発動）
- ✅ **11バック**（J で一時的に強さ逆転、場が流れるまで継続）
- ✅ **スペ3返し**（スペード3でジョーカー単体を倒せる、場を流す）
- ✅ **禁止上がり**（ジョーカー、2、8、スペード3で上がると負け）

#### プレイヤー構成
- 人間プレイヤー：1人
- CPU プレイヤー：3人（シンプルAI: 出せる最弱カードを選択）

#### 1ゲームのみ
- 階級制度なし（1ゲーム完結）
- カード交換なし
- 連続ゲームなし

#### UI操作
- カード選択：クリック
- カードプレイ：ボタンクリック
- パス：ボタンクリック

### Phase 1で実装しないもの

#### ローカルルール
- ❌ 革命（4枚出しで強さ逆転）
- ❌ 都落ち
- ❌ その他のローカルルール

#### 複雑な出し方
- ❌ 複数枚出し（同じ数字2枚以上）
- ❌ 階段出し

#### 階級システム
- ❌ 階級制度（大富豪、富豪、平民、貧民、大貧民）
- ❌ カード交換
- ❌ 連続ゲーム

#### その他
- ❌ ドラッグ&ドロップ操作
- ❌ 高度なアニメーション（USS transitionのみ）
- ❌ サウンド
- ❌ メインメニュー
- ❌ 設定画面（ルールのON/OFF切り替え）

---

## ユーザーシナリオ

### シナリオ1: ゲーム開始

**前提条件**:
- プレイヤーがシーンを開いた

**手順**:
1. ゲームが自動的に開始される
2. 54枚のカードが4人に配られる（Player 0: 14枚、Player 1: 14枚、Player 2-3: 13枚）
3. 人間プレイヤーの手札が画面下部に表示される
4. プレイヤー0（人間）から開始
5. ターン表示が「Your Turn」または「CPU X's Turn」と表示される

**期待される結果**:
- ゲームが正常に開始され、手札が表示される
- 誰のターンかが明確に表示される
- ジョーカーが含まれている（2枚）

### シナリオ2: 人間プレイヤーのターン - カードをプレイ

**前提条件**:
- 人間プレイヤーのターン
- 場にカードがある状態（例：♠5）

**手順**:
1. プレイヤーの手札から、場のカードより強いカード（例：♥7）をクリック
2. カードが選択状態になる（視覚的フィードバック）
3. 「Play Card」ボタンをクリック
4. カードが場に出される
5. 手札からカードが消える
6. ターンが次のプレイヤーへ移る

**期待される結果**:
- カードが正常にプレイされる
- 手札が更新される
- ターンが進行する

### シナリオ3: 人間プレイヤーのターン - パス

**前提条件**:
- 人間プレイヤーのターン
- 場に♠Aがある（手札に2がない）

**手順**:
1. 「Pass」ボタンをクリック
2. ターンが次のプレイヤーへ移る

**期待される結果**:
- パスが受け付けられる
- 手札は変わらない
- ターンが進行する

### シナリオ4: CPUプレイヤーのターン

**前提条件**:
- CPUプレイヤーのターン

**手順**:
1. CPUが自動的に思考（1.5秒待機）
2. CPUがカードをプレイ、またはパスする
3. 場が更新される
4. ターンが次のプレイヤーへ移る

**期待される結果**:
- CPUが適切にカードをプレイまたはパスする
- 処理が自動的に進行する

### シナリオ5: 場の流れ

**前提条件**:
- 場に♠Kがある
- 残り3人がパスした

**手順**:
1. 最後のプレイヤー（カードを出した人）の番が再び来る
2. 3人がパスしたことを確認
3. 場がクリアされる
4. プレイヤーが任意のカードを出せる

**期待される結果**:
- 場が正常にクリアされる
- 次のプレイヤーが任意のカードを出せる

### シナリオ6: 勝利

**前提条件**:
- プレイヤーの手札が1枚（♠A）
- 場に♣Kがある

**手順**:
1. プレイヤーが♠Aを選択
2. 「Play Card」ボタンをクリック
3. カードが場に出される
4. 手札が0枚になる
5. ゲーム終了画面が表示される
6. 「You Win!」と表示される

**期待される結果**:
- 勝利が正しく判定される
- ゲーム終了画面が表示される

### シナリオ7: 敗北

**前提条件**:
- CPUプレイヤーの手札が先に0枚になる

**手順**:
1. CPUが最後のカードをプレイ
2. CPUの手札が0枚になる
3. ゲーム終了画面が表示される
4. 「CPU X Wins!」と表示される

**期待される結果**:
- CPUの勝利が正しく判定される
- ゲーム終了画面が表示される

---

## 機能要件

### FR-001: カードデータ

**要件**:
システムは54枚のカード（52枚の標準トランプカード + ジョーカー2枚）を定義する。

**詳細**:
- 各カードはスート（♠♥♦♣）とランク（A, 2-10, J, Q, K）を持つ
- 各カードは強さの値を持つ（ジョーカー=16, 2=15, A=14, K=13, ..., 3=3）
- ジョーカーは最強のカード
- 各カードは視覚表現（スプライト）を持つ

### FR-002: カード配布

**要件**:
ゲーム開始時、54枚のカードを4人のプレイヤーに配る。

**詳細**:
- デッキをシャッフルする（Fisher-Yates法）
- プレイヤー0-1に14枚ずつ、プレイヤー2-3に13枚ずつ配る
- 配布はラウンドロビン方式（プレイヤー0→1→2→3→0...）

### FR-003: 手札表示

**要件**:
人間プレイヤーの手札を画面に表示する。

**詳細**:
- 手札のカードを全て表示
- カードは強さ順にソートして表示
- 各カードはクリック可能

### FR-004: ターン管理

**要件**:
システムは現在のターンを管理し、順番にプレイヤーの手番を進行する。

**詳細**:
- ターンは時計回り（プレイヤー0→1→2→3→0...）
- 現在のターンプレイヤーを表示
- ターンプレイヤー以外はアクション不可

### FR-005: カードプレイ（人間）

**要件**:
人間プレイヤーは自分のターンにカードをプレイできる。

**詳細**:
- 手札からカードをクリックして選択
- 「Play Card」ボタンで確定
- 場のカードより強いカードのみプレイ可能
- 場が空の場合は任意のカードをプレイ可能

### FR-006: カードプレイ（CPU）

**要件**:
CPUプレイヤーは自動的にカードをプレイする。

**詳細**:
- CPUのターン開始後、1.5秒待機
- プレイ可能なカードがあれば、最弱のカードをプレイ
- プレイ可能なカードがなければパス

### FR-007: パス機能

**要件**:
プレイヤーは自分のターンにパスできる。

**詳細**:
- 人間プレイヤーは「Pass」ボタンでパス
- CPUは自動的に判断してパス
- パス後、ターンは次のプレイヤーへ

### FR-008: 場の管理

**要件**:
システムは場に出されたカードを管理する。

**詳細**:
- 最後に出されたカードを記録
- 場のカードを画面中央に表示
- 場が流れたらカードをクリア

### FR-009: 場の流れ

**要件**:
カードを出したプレイヤー以外の全員がパスした場合、場が流れる。

**詳細**:
- 連続パスカウントを管理
- 3人連続パス（カードを出した人に戻る）で場をクリア
- 場が流れたら任意のカードをプレイ可能

### FR-010: ルール検証

**要件**:
システムはカードプレイのルールを検証する。

**詳細**:
- 場のカードより強いカードのみ許可
- 場が空の場合は全てのカードを許可
- ルール違反のカードは受け付けない

### FR-011: 勝敗判定

**要件**:
システムは手札が0枚になったプレイヤーを勝者とする。ただし、禁止上がりルールが有効な場合、禁止カードで上がったプレイヤーは敗者となる。

**詳細**:
- カードプレイ後、手札をチェック
- 手札が0枚なら勝利
- 禁止上がりルールが有効な場合、禁止カード（ジョーカー、2、8、スペード3）で上がると敗北
- 勝者または禁止上がり敗者が出たらゲーム終了

### FR-012: ゲーム終了画面

**要件**:
ゲーム終了時、結果を表示する。

**詳細**:
- 勝者の表示（「You Win!」または「CPU X Wins!」）
- 「Restart」ボタンでゲーム再開

### FR-013: UI状態管理

**要件**:
UIは現在のゲーム状態に応じて更新される。

**詳細**:
- ターン表示（「Your Turn」「CPU X's Turn」）
- プレイ可能カードのハイライト
- ボタンの有効/無効切り替え
  - 「Play Card」：カード選択時のみ有効
  - 「Pass」：自分のターンのみ有効

### FR-014: 8切りルール

**要件**:
8のカードがプレイされた時、場を即座にクリアし、同じプレイヤーが続行する。

**詳細**:
- 8がプレイされたら場を即座にリセット
- 8をプレイしたプレイヤーが続けて任意のカードをプレイ可能
- GameRulesSO.enable8Cutフラグで有効/無効を切り替え可能

### FR-015: 縛りルール

**要件**:
同じスートのカードが2枚連続でプレイされた時、次のプレイヤーは同じスートのカードのみプレイ可能となる。

**詳細**:
- 場の最後の2枚が同じスートの場合、縛りが発動
- 縛り中は同じスートのカードのみプレイ可能
- 場が流れるまで縛りは継続
- ジョーカーは縛りに影響しない
- GameRulesSO.enableBindフラグで有効/無効を切り替え可能

### FR-016: 11バックルール

**要件**:
J（ランク11）がプレイされた時、場が流れるまで一時的にカードの強さが逆転する。

**詳細**:
- Jがプレイされると、カード強さが一時的に逆転（3が最強、2が最弱）
- 場が流れるまで逆転状態が継続
- ジョーカーは11バック中も最強のまま
- GameRulesSO.enable11Backフラグで有効/無効を切り替え可能

### FR-017: スペ3返しルール

**要件**:
スペード3は単体のジョーカーを倒すことができる特殊ルール。

**詳細**:
- 場にジョーカー単体がある時、スペード3をプレイ可能
- スペード3でジョーカーを倒した場合、場を即座にリセット
- スペード3をプレイしたプレイヤーが続行
- 縛りルールを無視してプレイ可能
- GameRulesSO.enableSpade3Returnフラグで有効/無効を切り替え可能

### FR-018: 禁止上がりルール

**要件**:
特定のカード（ジョーカー、2、8、スペード3）で上がった場合、勝利ではなく敗北となる。

**詳細**:
- 禁止カード：ジョーカー、2、8、スペード3
- 禁止カードで手札が0枚になった場合、カードのプレイは成功するが敗北となる
- GameRulesSO.enableForbiddenFinishフラグで有効/無効を切り替え可能

---

## 成功基準

### SC-001: ゲームが完走できる

**基準**:
ゲーム開始から勝者決定まで、エラーなく完走できる。

**測定方法**:
手動プレイテストで5回連続完走

### SC-002: ルールが正しく適用される

**基準**:
大富豪の基本ルールとローカルルールが正しく機能する。

**測定方法**:
- 強いカードのみプレイ可能
- 場の流れが正常動作
- 勝敗判定が正確
- 8切りが正常動作（場がリセットされ、同じプレイヤー続行）
- 縛りが正常動作（同じスート2枚で発動）
- 11バックが正常動作（J で強さ逆転）
- スペ3返しが正常動作（スペード3がジョーカー単体を倒す）
- 禁止上がりが正常動作（禁止カードで上がると敗北）

### SC-003: CPUが適切にプレイする

**基準**:
CPUがルールに従って適切にプレイする。

**測定方法**:
- CPUがルール違反をしない
- CPUがプレイ可能な時にパスしない
- CPUが勝利できる

### SC-004: UI が分かりやすい

**基準**:
初めてプレイする人でも操作方法が分かる。

**測定方法**:
- ターン表示が明確
- プレイ可能カードが視覚的に分かる
- ボタン操作が直感的

---

## 制約条件

### 技術制約
- Unity 6.0.2.7f2
- UI Toolkit（100% UXML/USS）
- Tang3cko.EventChannels
- 解像度：1920x1080

### ゲームデザイン制約
- Phase 1は1枚出しのみ
- ローカルルール非対応
- 1ゲーム完結（階級なし）

---

## 次のステップ

この仕様書を基に、以下を実行する：

1. **/clarify**: 曖昧な部分を明確化
2. **/plan**: 技術実装計画の策定
3. **/tasks**: 実装タスクへの分解
4. **/implement**: 実装の実行
